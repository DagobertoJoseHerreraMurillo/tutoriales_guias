---
title: "¿Cómo conectarse a los datos abiertos de la muni de San José?"
author: "ronny hdez-mora"
date: "February 9, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(junr)
library(dplyr)
```

## Datos disponibles

Gracias a la iniciativa de [Gobierno Abierto](http://www.gobiernoabierto.go.cr/)
de Costa Rica tenemos la posibilidad de obtener datos de diferentes entes a través
de la conexión con API's.

Esto nos da la posibilidad de no pasar por engorrosos procesos de limpiar datos
a partir de formatos casi imposibles como pdf's, .csv extravagantes u otros
formatos difíciles de trabajar.

En este caso vamos a utilizar el lenguaje de programación R y el paquete 
[junr](https://cran.r-project.org/web/packages/junr/index.html) de
[Frans van Dunné](https://github.com/FvD) para conectarnos al API de la municipalidad
de San José y revisar qué datos se encuentran disponibles.

### Obtener el API key de la municipalidad de San José

En la siguiente [dirección](http://datosabiertos.msj.go.cr/developers/) podrá encontrar el API key necesario para hacer el llamado.

```{r, echo = FALSE}
SU_API_KEY <- Sys.getenv("SU_API_KEY")
```

Vamos a crear como objetos nuestras credenciales para hacer la conexión al
API de la municipalidad de San José. El url que aparece acá es el que se debe
de usar para conectarnos al sistema de la muni de San José. Si están siguiendo
ete ejemplo pueden escribir el mismo que aparece acá.
```{r}
url_base <- "http://api.datosabiertos.msj.go.cr/api/v2/datastreams/"
api_key <- SU_API_KEY
```

Ya que tenemos las credenciales listas (api key & url), vamos a revisar el
índice de las tablas de datos que la municipalidad ha liberado:
```{r}
# Traemos el indice  de los datos que existen
indice <- get_index(url_base, api_key = api_key)

# Revisamos el objeto
indice
```

Cada uno de los elementos que allí aparecen son distintas tablas que pueden
tener diferentes dimensiones (filas y columnas). Es como una descripción de lo
que trata cada tabla. Si queremos traer a nuestro entorno los datos de una tabla
en específico
```{r}
# Necesitamos el guid para hacer un llamado especifico a los datos
guid <- indice %>% 
  select(title, guid)

# Por la cantidad de tablas que hay, esta funcion se demora mucho
dimensiones <- get_dimensions(base_url = url_base, api_key = api_key)

# Unir el titulo a dimensiones
dimensiones <- left_join(dimensiones, guid, by = c("GUID" = "guid"))

# Ordenar tablas con mayores dimensiones
dim_ordenado <- dimensiones %>%
    arrange(desc(DIM))

# Exportar guia de tablas
# feather::write_feather(dim_ordenado, "dim_tablas_munisj.feather")

```

## Elegir un conjunto de datos
```{r}
guid <- "ASIST-EDUCA-SUPER"
asist_educacion <- get_data(base_url = url_base, api_key = api_key, guid = guid)
```




